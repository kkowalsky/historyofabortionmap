function initialize(){expressed=Category[0],yearExpressed=keyArray[keyArray.length-1],animateMap(yearExpressed,colorize,yearExpressedText),setMap(),createMenu(arrayOverview,colorArrayOverview,"Grading Scale: ",textArray[0],linkArray[0]),createInset(),$(".Overview").css({"background-color":"#CCCCCC",color:"#333333"}),$(".stepBackward").prop("disabled",!0),$(".play").prop("disabled",!0),$(".pause").prop("disabled",!0),$(".stepForward").prop("disabled",!0)}function setMap(){function e(e,t,o,n,s,i,l,c,d,p){function u(e,r,t){for(var a=c.objects.states.geometries,o=0;o<r.length;o++)for(var n=r[o],s=n.adm,i=0;i<a.length;i++)if(a[i].properties.postal==s){attrObj={};for(var l in keyArray){var d=keyArray[l],p=n[d];attrObj[d]=p}a[i].properties[t]=attrObj;break}}joinedJson=topojson.feature(c,c.objects.states).features,colorize=colorScale(joinedJson);var y=[t,o,n,s,i,l],h=["gradeData","prohibitedAfter","counseling","waitingPeriod","consentData","ultrasound"];for(csv in y)u(c,y[csv],h[csv]);for(var f=r.selectAll(".states").data(joinedJson).enter().append("path").attr("class",function(e){return"states "+e.properties.postal}).style("fill",function(e){return choropleth(e,colorize)}).attr("d",function(e){return a(e)}).on("mouseover",highlight).on("mouseout",dehighlight).on("mousemove",moveLabel),b=(f.append("desc").text(function(e){return choropleth(e,colorize)}),[]),g=0;g<d.features.length;g++){var v=d.features[g].properties.Count;b.push(Number(v))}for(var m=Math.min.apply(Math,b),x=Math.max.apply(Math,b),A=d3.scale.sqrt().domain([m,x]).range([2,20]),C=[],w=0;w<p.features.length;w++){var k=p.features[w].properties.Count;C.push(Number(k))}var M=Math.min.apply(Math,C),$=Math.max.apply(Math,C),E=d3.scale.sqrt().domain([M,$]).range([2,23]);setChart(),overlay(a,A,E,r,d,p),drawMenuInfo(colorize,yearExpressed)}var r=d3.select(".map").append("svg").attr("width",mapWidth).attr("height",mapHeight).attr("class","us-map"),t=d3.geo.albersUsa().scale(900).translate([mapWidth/2,mapHeight/2]),a=d3.geo.path().projection(t);queue().defer(d3.csv,"data/grades.csv").defer(d3.csv,"data/prohibitedAfter.csv").defer(d3.csv,"data/counseling.csv").defer(d3.csv,"data/waitingPeriod.csv").defer(d3.csv,"data/consent.csv").defer(d3.csv,"data/ultrasound.csv").defer(d3.json,"data/usa.topojson").defer(d3.json,"data/CPCS.geojson").defer(d3.json,"data/AbortionProviders.geojson").await(e),drawMenu()}function drawMenu(){$(".Overview").click(function(){expressed=Category[0],yearExpressed=keyArray[keyArray.length-1],d3.selectAll(".yearExpressedText").remove(),drawMenuInfo(colorize,yearExpressed),$(".stepBackward").prop("disabled",!0),$(".play").prop("disabled",!0),$(".pause").prop("disabled",!0),$(".stepForward").prop("disabled",!0),d3.selectAll(".menu-options div").style({"background-color":"#e1e1e1",color:"#969696"}),d3.selectAll(".states").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)}),createMenu(arrayOverview,colorArrayOverview,"Grading Scale: ",textArray[0],linkArray[0]),$(".Overview").css({"background-color":"#CCCCCC",color:"#333333"});d3.selectAll(".chart").remove(),d3.selectAll(".chartRect").remove()}),$(".Prohibited").click(function(){expressed=Category[1],$(".stepBackward").prop("disabled",!1),$(".play").prop("disabled",!1),$(".pause").prop("disabled",!1),$(".stepForward").prop("disabled",!1),d3.selectAll(".menu-options div").style({"background-color":"#e1e1e1",color:"#969696"}),d3.selectAll(".states").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)}),createMenu(arrayProhibited,colorArrayProhibited,"Prohibited At: ",textArray[1],linkArray[1]),$(".Prohibited").css({"background-color":"#CCCCCC",color:"#333333"});d3.select(".chart").remove(),d3.selectAll(".chartRect").remove();setChart()}),$(".Counseling").click(function(){expressed=Category[2],$(".stepBackward").prop("disabled",!1),$(".play").prop("disabled",!1),$(".pause").prop("disabled",!1),$(".stepForward").prop("disabled",!1),d3.selectAll(".menu-options div").style({"background-color":"#e1e1e1",color:"#969696"}),d3.selectAll(".states").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)}),createMenu(arrayCounseling,colorArrayCounseling,"Mandated Counseling: ",textArray[2],linkArray[2]),$(".Counseling").css({"background-color":"#CCCCCC",color:"#333333"});d3.select(".chart").remove(),d3.selectAll(".chartRect").remove();setChart()}),$(".Waiting").click(function(){expressed=Category[3],$(".stepBackward").prop("disabled",!1),$(".play").prop("disabled",!1),$(".pause").prop("disabled",!1),$(".stepForward").prop("disabled",!1),d3.selectAll(".menu-options div").style({"background-color":"#e1e1e1",color:"#969696"}),d3.selectAll(".states").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)}),createMenu(arrayWaitingPeriod,colorArrayOverview,"Waiting Period: ",textArray[3],linkArray[3]),$(".Waiting").css({"background-color":"#CCCCCC",color:"#333333"});d3.select(".chart").remove(),d3.selectAll(".chartRect").remove();setChart()}),$(".Parental").click(function(){expressed=Category[4],$(".stepBackward").prop("disabled",!1),$(".play").prop("disabled",!1),$(".pause").prop("disabled",!1),$(".stepForward").prop("disabled",!1),d3.selectAll(".menu-options div").style({"background-color":"#e1e1e1",color:"#969696"}),d3.selectAll(".states").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)}),createMenu(arrayConsent,colorArrayConsent,"Parental Consent: ",textArray[4],linkArray[4]),$(".Parental").css({"background-color":"#CCCCCC",color:"#333333"});d3.select(".chart").remove(),d3.selectAll(".chartRect").remove();setChart()}),$(".Ultrasound").click(function(){expressed=Category[5],$(".stepBackward").prop("disabled",!1),$(".play").prop("disabled",!1),$(".pause").prop("disabled",!1),$(".stepForward").prop("disabled",!1),d3.selectAll(".menu-options div").style({"background-color":"#e1e1e1",color:"#969696"}),d3.selectAll(".states").style("fill",function(e){return choropleth(e,colorize)}).select("desc").text(function(e){return choropleth(e,colorize)}),createMenu(arrayUltrasound,colorArrayUltrasound,"Mandatory Ultrasound: ",textArray[5],linkArray[5]),$(".Ultrasound").css({"background-color":"#CCCCCC",color:"#333333"});d3.select(".chart").remove(),d3.selectAll(".chartRect").remove();setChart()})}function drawMenuInfo(e,r){yearExpressedText=d3.select(".menu-info").append("text").attr("x",0).attr("y",0).attr("class","yearExpressedText menu-info").text(r).style({"font-size":"36px","font-weight":"strong"})}function animateMap(e,r){$(".stepBackward").click(function(){if(e<=keyArray[keyArray.length-1]&&e>keyArray[0])e--,changeAttribute(e,r);else{var t=keyArray[keyArray.length-1];changeAttribute(t,r)}}),$(".play").click(function(){timer.play(),$(".play").prop("disabled",!0)}),$(".pause").click(function(){timer.pause(),$(".play").prop("disabled",!1),changeAttribute(e,r)}),$(".stepForward").click(function(){e<keyArray[keyArray.length-1]?(e++,changeAttribute(e,r)):(e=keyArray[0],changeAttribute(e,r))})}function timeMapSequence(e){e<keyArray[keyArray.length-1]&&yearExpressed++,changeAttribute(yearExpressed,colorize)}function changeAttribute(e,r){d3.selectAll(".yearExpressedText").remove();for(x=0;x<keyArray.length;x++)e==keyArray[x]&&(yearExpressed=keyArray[x]);d3.selectAll(".states").style("fill",function(e){return choropleth(e,r)}).select("desc").text(function(e){return choropleth(e,r)}),drawMenuInfo(r,yearExpressed)}function createMenu(e,r,t,a,o){{var n=[40,85,130,175,220,265];d3.selectAll(".menuBox").remove(),d3.selectAll(".menuInfoBox").remove()}menuBox=d3.select(".menu-inset").append("svg").attr("width",menuWidth).attr("height",menuHeight).attr("class","menuBox");menuBox.append("text").attr("x",10).attr("y",30).attr("class","title").text(t).style("font-size","16px");for(b=0;b<e.length;b++){var s=menuBox.selectAll(".items").data(e).enter().append("rect").attr("class","items").attr("width",40).attr("height",40).attr("x",15);s.data(n).attr("y",function(e){return e}),s.data(r).attr("fill",function(e,t){return r[t]})}var i=menuBox.selectAll(".menuLabels").data(e).enter().append("text").attr("class","menuLabels").attr("x",60).text(function(r,t){for(var a=0;a<e.length;a++)return e[t]}).style({"font-size":"14px","font-family":"Open Sans, sans-serif"});i.data(n).attr("y",function(e){return e+30}),menuInfoBox=d3.select(".menu-info").append("div").attr("width",menuInfoWidth).attr("height",menuInfoHeight).attr("class","menuInfoBox textBox").html(a+o)}function overlay(e,r,t,a,o,n){$(".cpc-section").click(function(){var t=document.getElementById("cpc-centers"),n=document.getElementById("cpc-inset");d3.selectAll(".cpcLocations")[0].length>0?(removeCPC=d3.selectAll(".cpcLocations").remove(),removeCPCInfo=d3.selectAll(".cpcMenuInfoBox").remove(),n.style.visibility="hidden",t.style.backgroundColor="rgba(250, 110, 57, 1)"):(cpcPoints(a,o,e,r),n.style.visibility="visible",t.style.backgroundColor="#f95618")}),$(".abortion-section").click(function(){var r=document.getElementById("abortion-centers"),o=document.getElementById("abortion-inset");d3.selectAll(".abortionLocations")[0].length>0?(removeAbortion=d3.selectAll(".abortionLocations").remove(),removeAbortionInfo=d3.selectAll(".abortionMenuInfoBox").remove(),o.style.visibility="hidden",r.style.backgroundColor="rgba(55, 196, 171, 1)"):(abortionPoints(a,n,e,t),o.style.visibility="visible",r.style.backgroundColor="#248271")})}function cpcPoints(e,r,t,a){e.selectAll(".cpcLocations").data(r.features).enter().append("path").attr("class","cpcLocations").attr("d",t.pointRadius(function(e){return a(e.properties.Count)}));d3.select(".sequence-buttons").append("div").attr("width",menuInfoWidth).attr("height",menuInfoHeight).attr("class","cpcMenuInfoBox").html(textArray[6]+linkArray[6])}function abortionPoints(e,r,t,a){e.selectAll(".abortionLocations").data(r.features).enter().append("path").attr("class","abortionLocations").attr("d",t.pointRadius(function(e){return a(e.properties.Count)}));d3.select(".sequence-buttons").append("div").attr("width",menuInfoWidth).attr("height",menuInfoHeight).attr("class","abortionMenuInfoBox").text(textArray[7])}function createInset(){var e=(d3.selectAll(".cpcCircles").remove(),d3.selectAll(".abortionCircles").remove(),[2,11.85,20]),r=[1,4,8],t=[2,16.23,20],a=[1,6,11];cpcMenuBox=d3.select(".cpc-inset").append("svg").attr("width",otherMenuWidth).attr("height",otherMenuHeight).attr("class","cpcmenuBox");var o=(cpcMenuBox.selectAll(".cpcCircles").data(e).enter().append("circle").attr("cy",30).attr("cx",function(e,r){return 1*e+50*r+10}).attr("r",function(e){return e}).attr("class","cpcCircles").style({fill:"#FA6E39","fill-opacity":"0.7"}),cpcMenuBox.selectAll(".cpcOverlayLabels").data(r).enter().append("text").attr("class","cpcOverlayLabels").attr("y",35).text(function(e,t){for(var a=0;a<r.length;a++)return r[t]}).style({"font-size":"14px","font-family":"Open Sans, sans-serif"}));o.data(e).attr("x",function(e,r){return 2*e+50*r+15}),abortionMenuBox=d3.select(".abortion-inset").append("svg").attr("width",otherMenuWidth).attr("height",otherMenuHeight).attr("class","abortionMenuBox");var n=(abortionMenuBox.selectAll(".abortionCircles").data(t).enter().append("circle").attr("cy",30).attr("cx",function(e,r){return 1*e+50*r+10}).attr("r",function(e){return e}).attr("class","abortionCircles").style({fill:"#37C4AB","fill-opacity":"0.7"}),abortionMenuBox.selectAll(".abortionOverlayLabels").data(a).enter().append("text").attr("class","abortionOverlayLabels").attr("y",35).text(function(e,r){for(var t=0;t<a.length;t++)return a[r]}).style({"font-size":"14px","font-family":"Open Sans, sans-serif"}));n.data(t).attr("x",function(e,r){return 2*e+50*r+15})}function colorScale(e){return"gradeData"===expressed?(currentColors=colorArrayOverview,currentArray=arrayOverview):"consentData"===expressed?(currentColors=colorArrayConsent,currentArray=arrayConsent):"prohibitedAfter"===expressed?(currentColors=colorArrayProhibited,currentArray=arrayProhibited):"counseling"===expressed?(currentColors=colorArrayCounseling,currentArray=arrayCounseling):"waitingPeriod"===expressed?(currentColors=colorArrayOverview,currentArray=arrayWaitingPeriod):"ultrasound"===expressed&&(currentColors=colorArrayUltrasound,currentArray=arrayUltrasound),scale=d3.scale.ordinal().range(currentColors).domain(currentArray),scale(e[yearExpressed])}function colorScaleChart(e){return"gradeData"===expressed?(currentColors=colorArrayOverview,currentArray=arrayOverview):"consentData"===expressed?(currentColors=colorArrayConsent,currentArray=arrayConsent):"prohibitedAfter"===expressed?(currentColors=colorArrayProhibited,currentArray=arrayProhibited):"counseling"===expressed?(currentColors=colorArrayCounseling,currentArray=arrayCounseling):"waitingPeriod"===expressed?(currentColors=colorArrayOverview,currentArray=arrayWaitingPeriod):"ultrasound"===expressed&&(currentColors=colorArrayUltrasound,currentArray=arrayUltrasound),scale=d3.scale.ordinal().range(currentColors).domain(currentArray),scale(e)}function choropleth(e){var r=e.properties?e.properties[expressed]:e;return colorScale(r)}function choroplethChart(e){return colorScaleChart(e)}function setChart(){timelineFeatureArray=[],colorizeChart=colorScaleChart(timelineFeatureArray);var e=d3.select(".graph").append("svg").attr("width",chartWidth+"px").attr("height",chartHeight+"px").attr("class","chart").append("g").attr("transform","translate("+margin.left+", "+margin.top+")");for(var r in joinedJson)for(var t=joinedJson[r],a=1;a<=keyArray.length-1;a++){var o=a-1;t.properties[expressed][keyArray[a]]!=t.properties[expressed][keyArray[o]]&&timelineFeatureArray.push({yearChanged:Number(keyArray[a]),newLaw:t.properties[expressed][keyArray[a]],feature:t})}var n=[];for(key in keyArray){var s=1;for(i=0;i<timelineFeatureArray.length;i++)timelineFeatureArray[i].yearChanged==keyArray[key]&&(n.push({year:Number(keyArray[key]),count:s}),s=s++)}chartRect=e.selectAll(".chartRect").data(timelineFeatureArray).enter().append("rect").attr("class",function(e){return"chartRect "+e.feature.properties.postal}).attr("width",squareWidth+"px").attr("height",squareHeight+"px");var l=d3.scale.linear().domain([keyArray[0],keyArray[keyArray.length-1]]).rangeRound([0,chartWidth-margin.left-margin.right]),c=chartRect.attr("transform",function(e){return"translate("+l(e.yearChanged)+")"}).attr("y",function(e,r){var t=0;for(r=0;r<n.length;r++)n[r].year==e.yearChanged&&(t=n[r].count*(squareHeight+1),n[r].count-=1);return t}).style("fill",function(e){return choroplethChart(e.newLaw,colorize)}).on("mouseover",highlight).on("mouseout",dehighlight);rectColor=c.append("desc").text(function(e){return choropleth(e,colorize)})}function highlight(e){var r=e.properties?e.properties:e.feature.properties;d3.selectAll("."+r.postal).style("fill","#8856A7");var t,a=r.name;"gradeData"==expressed?t="Report Card: "+r[expressed][Number(yearExpressed)]:"prohibitedAfter"==expressed?t=yearExpressed+"<br>Prohibited at "+r[expressed][Number(yearExpressed)]:"counseling"==expressed?"Yes"==r[expressed][Number(yearExpressed)]?t=yearExpressed+"<br>Pre-abortion counseling mandated by law":"No"==r[expressed][Number(yearExpressed)]&&(t=yearExpressed+"<br>No mandated counseling"):"waitingPeriod"==expressed?t="None"==r[expressed][Number(yearExpressed)]?yearExpressed+"<br>No mandated waiting period":yearExpressed+"<br>Mandated waiting period: "+r[expressed][Number(yearExpressed)]:"consentData"==expressed?"none"==r[expressed][Number(yearExpressed)]?t=yearExpressed+"<br>No law requiring parental consent for minors":"notice"==r[expressed][Number(yearExpressed)]?t=yearExpressed+"<br>Minor must notify parents about an abortion":"consent"==r[expressed][Number(yearExpressed)]&&(t=yearExpressed+"<br>Minor's parents must give consent before abortion can be performed"):"ultrasound"==expressed&&(t="none"==r[expressed][Number(yearExpressed)]?yearExpressed+"<br>No mandatory ultrasound law":yearExpressed+"<br>"+r[expressed][Number(yearExpressed)]);var t=(d3.select(".map").append("div").attr("class","infoLabel").attr("id",r.postal+"label").attr("padding-left","500px"),d3.select(".infoLabel").html(a).attr("class","labelTitle"),d3.select(".labelTitle").append("div").html(t).attr("class","labelAttribute"))}function dehighlight(e){var r=e.properties?e.properties:e.feature.properties,t=d3.selectAll("."+r.postal),a=t.select("desc").text();t.style("fill",a);d3.select("#"+r.postal+"label").remove()}function moveLabel(){var e=d3.event.clientX<window.innerWidth-245?d3.event.clientX+10:d3.event.clientX-210,r=d3.event.clientY<window.innerHeight-100?d3.event.clientY-75:d3.event.clientY-175;d3.select(".infoLabel").style("margin-left",e+"px").style("margin-top",r+"px")}var mapWidth=750,mapHeight=400,keyArray=["1973","1974","1975","1976","1977","1978","1979","1980","1981","1982","1983","1984","1985","1986","1987","1988","1989","1990","1991","1992","1993","1994","1995","1996","1997","1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014"],Category=["gradeData","prohibitedAfter","counseling","waitingPeriod","consentData","ultrasound"],expressed,yearExpressed,yearExpressedText,colorize,scale,currentColors=[],menuWidth=200,menuHeight=300,otherMenuWidth=198,otherMenuHeight=70,menuInfoWidth=400,menuInfoHeight=100,textArray=["The report card grade, created by NARAL, given to each state based on their policies regarding a woman's choice and access to abortions. ","States that prohibit abortion at an earlier gestation date than the federal law of viability. ","States that require biased counseling to women seeking abortion services. ","States where a woman must wait a designated period of time after counseling before having an abortion. ","States with laws that restrict young women's access to abortion services by mandating parental consent. ","States where an ultrasound either must be performed, offered, or advised prior to an abortion. ","Crisis Pregnancy Centers provide counseling but appose and undermine abortion rights. ","Abortion Providers provide counseling and do not promote abortion but help women in need of one. "],linkArray=["<a href = '#overview'> We provide an overview of these policies here.</a>","<a href = '#prohibition'>  What sort of prohibitions?</a>","<a href = '#counseling'> What constitutes biased counseling?</a>","<a href = '#waiting'> Why are waiting periods considered a restriction?</a>","<a href = '#consent'> Why is parental consent considered a restriction?</a>","<a href = '#ultrasound'> What are the differences between these laws?</a>","<a href = '#CPC'> Here's why.</a>"],removeCPC,removeAbortion,joinedJson,arrayOverview=["F","D","C","B","A"],arrayProhibited=["12 weeks","20 weeks","22 weeks","24 weeks","3rd trimester","Viability"],arrayCounseling=["Yes","No"],arrayWaitingPeriod=["72 hours","48 hours","24 hours","18 hours","None"],arrayConsent=["consent","notice","none"],arrayUltrasound=["Must be performed","Must be offered","Must be informed","none"],colorArrayOverview=["#525252","#737373","#969696","#bdbdbd","#d9d9d9"],colorArrayProhibited=["#525252","#737373","#969696","#bdbdbd","#d9d9d9","#efefef"],colorArrayCounseling=["#525252","#d9d9d9"],colorArrayConsent=["#525252","#969696","#d9d9d9"],colorArrayUltrasound=["#525252","#737373","#969696","#d9d9d9"],currentColors=[],currentArray=[],timelineFeatureArray=[],colorizeChart,removeChart,chartHeight=200,chartWidth=855,squareWidth=19,squareHeight=19,chartRect,margin={top:80,right:20,bottom:30,left:10},rectColor;window.onload=initialize(),$(function(){$(".nav li a").on("click",function(){var e=$(this).parent("li"),r=e.parent("ul");e.hasClass("active")||(r.find("li.active").removeClass("active"),e.addClass("active"))})});var timer=$.timer(function(){animateMap(yearExpressed,colorize,yearExpressedText),timeMapSequence(yearExpressed)});timer.set({time:500,autostart:!1});